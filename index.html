<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>PianoFun</title>
    <link rel="stylesheet" href="./style/styleNew.css">
    <link rel="stylesheet" href="../global/globalStyle.css">

    <script src="./SwagLib.js"></script>
</head>

<body>
<section>
    <!--<a  href=" ./home/" target="_blank">HOME</a>-->
    <!--<a  href=" ./play/" target="_blank">PLAY</a>-->
    <!--<a  href=" ./about/" target="_blank">ABOUT</a>-->


    <div class="gameHead"> -> Use Firefox. Hold space bar and keys for hyperspace!<- </div>


</section>
    <!-- <div class="sideBar">
            <button class="btn"> HASDOISD</button>

        </div> -->
    <div class="pianoKeys" id="mypiano"></div>
    <div id="inputLegend">
    </div>
    <footer>
        <label class="switch">
            <input type="checkbox" checked id="slider">
            <div class="slider round"></div>
        </label>
        <div class="tips">
            <div class="tipleft"><span>Shift</span></div>
            <!-- <div class="tipright"><span>asd</span></div> -->
        </div>
        <div class="tips">
            <div class="tipleft"><span>Command</span></div>
            <!-- <div class="tipright"><span>asd</span></div> -->
        </div>

        <div class="chordDisplay">
            <div class="chordRoot" id="root"><span id="basenote"></span></div>
            <div class="chordExtend"><span id="chordtext"></span></div>
        </div>

        <div class="tips">
            <div class="tipleft"><span>Space!</span></div>
            <!-- <div class="tipright"><span>asd</span></div> -->
        </div>
        <div class="tips">
            <div class="tipleft"><span>Option / Alt</span></div>
            <!-- <div class="tipright"><span>asd</span></div> -->
        </div>
    </footer>
</body>

</html>

<script>
    // ---- EVENT HANDLERS
    window.addEventListener("load", init);
    window.onkeydown = keyDown;
    // document.onkeydown = keyDown;
    window.onkeyup = keyUp;

    var isFirefox = typeof InstallTrigger !== 'undefined';
    var isChrome = !!window.chrome && !!window.chrome.webstore;
        var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window['safari'] || safari.pushNotification);


    let mobilecheck = function() {
        var check = false;
        (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
        return check;
    };

    let isMobile = mobilecheck();
    if (isMobile) {
        alert("Not made for phones. Come back when you're at your desktop / mac")
    }

    if ( !isFirefox && !isChrome && !isSafari) {
        alert("As of May 2019, this Game only works well in FIREFOX! CHROME has bugs with keystrokes and oscillators – you might not hear anything)
    }

    // ---- DECLARATIONS -----
    // let display = document.getElementById("display");
    // display.textContent = "Play";

    let AUDIO_CTX;
    const BASE_OCTAVE = 5;
    const KEYS_IN_GAME = 13; //1 OCTAVE
    const OSC_TYPES = ["triangle", "square", "sine"];
    // const KEYCODEMAPPING_ZIGZAG = [65, 87, 83, 69, 68, 82, 70, 84, 71, 89, 72, 85, 74, 73];
    // const KEYCODEMAPPING_PIANO = [65, 87, 83, 69, 68, 70, 84, 71, 89, 72, 85, 74, 75];

    let KEYCODES_NUMERALS;
    //because the web sucks...
    if (navigator.userAgent.indexOf("Firefox") > 0 || navigator.userAgent.indexOf("Mozilla") ) {
        KEYCODES_NUMERALS = [192, 49, 50, 51, 52, 53, 54, 55, 56, 57, 48, 173, 61];
    } else {
        KEYCODES_NUMERALS  = [192, 49, 50, 51, 52, 53, 54, 55, 56, 57, 48, 189, 187];
    }

    let KEYCODES;

    const KEYCODEMAPPING_PIANO = [65, 87, 83, 69, 68, 70, 84, 71, 89, 72, 85, 74, 75];

    const CHARS = ["`", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "="];
    const CHARS_2 = ["A","W", "S", "E", "D", "F", "T", "G", "Y", "H", "U", "J", "K"];

    let keys = [KEYCODEMAPPING_PIANO.slice(), KEYCODES_NUMERALS.slice()]
    let chars = [CHARS_2, CHARS];
    let keyChoice = 0;
    const slider = document.getElementById("slider");
    const charDiv = document.getElementById("inputLegend");
    KEYCODES = changeMappingandKeycode(keys, chars, keyChoice);
    keyChoice++;


    slider.addEventListener("change", function () {
            KEYCODES = changeMappingandKeycode(keys, chars, keyChoice);
            keyChoice++;

    });

    function changeMappingandKeycode(keycodes, mapping, counter) {
        counter = counter % 2;
        let KEYCODES = keycodes[counter];
        while (charDiv.hasChildNodes()) {
            charDiv.removeChild(charDiv.lastChild);
        }

        spans = ArrayToSpans(mapping[counter]);

        spans.forEach(span => {
            charDiv.appendChild(span);
        });

        return KEYCODES;
    }

    function ArrayToSpans(mapping) {
        let spans = [];
        mapping.forEach (function (char) {
            const span = document.createElement("span");
            span.innerHTML = char;
           spans.push(span)
        });
        return spans;
    }




    const CHORD_STRUCTURES = [
        ["Major", 4, 7],
        ["Major6th", 4, 7, 9],
        ["Dominant7th", 4, 7, 10],
        ["Major7th", 4, 7, 11],
        ["Minor", 3, 7],
        ["Minor6th", 3, 7, 9],
        ["Minor7th", 3, 7, 10],
        ["Augmented", 4, 8],
        ["Diminished7th", 3, 6, 9],
        ["Suspended4", 5, 7],
        ["Suspended2", 2, 7]
    ];
    const CHORDS_ABBREVIATED = {
        Major: "",
        Major6th: "maj6",
        Dominant7th: "7",
        Major7th: "m7",
        Minor: "m",
        Minor6th: "m6",
        Minor7th: "m7",
        Augmented: "aug",
        Diminished7th: "dim7",
        Suspended4: "sus4",
        Suspended2: "sus2"
    }

    //--------- GLOBALS
    let pianoKeys = []; //STORES DATA
    let chord;
    let keyMapDivs = [];
    let piano; //REFERENCE TO CSS / DOM
    let notesPressed = [];
    let deltaBase = 0;
    let spacePressed = false;
    let resetPressed = false;
    let sinusTimer = 0; //for mouth flickering in loop (up down);

    //DIVS
    let chordExtend = document.getElementById("chordtext");
    let basenoteText = document.getElementById("basenote");
    let rootBG = document.getElementById("root");
    rootBG.style.border = "1px solid rgba(250, 251, 246, 0.14)";


    //    console.log(chordExtend);
    //TELLS US WHAT'S GOING ON with FINGERS
    // let AUDIO_CTX = new AudioContext();


    // ---------
    function init() {
        try {
            window.AudioContext = window.AudioContext || // Fix up for prefixing
                window.webkitAudioContext ||
                window.mozAudioContext ||
                window.oAudioContext ||
                window.msAudioContext;

            AUDIO_CTX = new AudioContext();
        } catch (e) {
            alert('Web Audio API is not supported in this browser');
        }

        let pianoDiv = document.getElementById("mypiano");
        // pianoKeys = setupKeysinDiv(pianoDiv, AUDIO_CTX); //give children
        pianoKeys = createKeyDiv(KEYS_IN_GAME);
        for (let i = 0; i < pianoKeys.length; i++) {
            pianoKeys[i].insertText(chromaticC3[i]); //CDEFG

            if (AUDIO_CTX) { //connect OSC
                let freq = midiToFreq(i + 12 * BASE_OCTAVE);
                pianoKeys[i].setOsc(AUDIO_CTX, freq, "triangle")
            }

            pianoDiv.appendChild(pianoKeys[i].divElem);
        };

        piano = Array.from(pianoDiv.children); //put them in data

        //ADD FACE
        for (let keys of piano) {
            let face = ["eyeleft", "mouth", "eyeright"];
            let faceContainer = document.createElement("div");
            faceContainer.setAttribute("class", "face"); //for flex aligning easier
            for (let j = 0; j < face.length; j++) {
                let namediv = document.createElement("div");
                namediv.setAttribute("class", face[j]);
                faceContainer.appendChild(namediv);
            }
            keys.appendChild(faceContainer);
        }
        loop();
    }

    function loop() {
        sinusTimer += 0.5;

        for (i = 0; i < pianoKeys.length; i++) {

            // ---- CHANGE MODEL BASED ON INPUT ––––––
            let model = pianoKeys[i];
            let view = piano[i];
            if (notesPressed.includes(i)) {
                model.changeHeight("up"); //increase only pressed boxes
            } else {
                model.changeHeight("down");
                try {
                    model.osc.disconnect(model.audioCtx.destination)
                }
                catch(e) {

                }
            }

            // --SPECIAL EVENTS
            let newFreq = model.osc.frequency.value;

            if (spacePressed) {
                newFreq *= Math.pow(SEMITONE_FACTOR, 1 / 30);//1/60 --> increase freq by 1 semitone every second
                model.note = Math.round (HzToMIDI(newFreq) % 12); //need for shifted chord recognition
            }
            if (resetPressed) {
                newFreq = midiToFreq(i + 12 * BASE_OCTAVE);
                model.note = Math.round (HzToMIDI(newFreq) % 12);
            }

            model.osc.frequency.value = newFreq;
            model.color = FreqToHSLa(newFreq, undefined, "62.5%", 1);



            //-------------  CHANGE VIEW based on MODEL
            view.style.background = model.color;
            let newNote = Math.round((HzToMIDI(newFreq) % 12)); //translate frequency to 0 -12 sheme
            // deltaBase = Math.round(HzToMIDI(pianoKeys[0].osc.frequency.value) % 12);
            view.children[0].textContent = chromaticC3[newNote];
            view.style.height = model.myHeight + "vh";
            view.style.borderTopLeftRadius = model.borderRad + "px";
            view.style.borderTopRightRadius = model.borderRad + "px";
            //text =0; face = 1
            view.children[1].style.transform = "scale(" + model.percentage + ")"; //face shows up
            view.children[1].children[1].style.transform = "scale(" + (model.percentage * 2 - Math.sin(sinusTimer) / 14) + ")";
            //face twiggles (fluctuates while smiling)
        }

        // --- GUESS CHORDS for display!
        chord = notesToChordGuess(notesPressed.map(el => el+ pianoKeys[0].note), CHORD_STRUCTURES).split(" ");
            //map offset on notespressed for this function
        //intervals in ascending order;
        // [0] = baseNote, 1 = Name;
//
            chordExtend.innerText = CHORDS_ABBREVIATED[chord[1]] || "";
            basenoteText.innerText = chord[0] || "";
            // console.log(base);
      if (chord[1]) {
            rootBG.style.background = NumberToHSLa(chromaticC3.indexOf(chord[0]), undefined, "70%", 1) || "";
      }
        requestAnimationFrame(loop);
    }

    const createKeyDiv = function(count) { //TODO seperate div --> array; setOsc and appendChild;
        let arr = [];
        for (let i = 0; i < KEYS_IN_GAME; i++) {
            let key = new KeyBox(i);
            arr.push(key);
        }
        return arr;
    }

    function keyUp(ev) {
        notesPressed = notesPressed.filter(
            el => el !== KEYCODES.indexOf(ev.keyCode)
            //remove notes that were released at keyUp
        );
        // osc.stop(); //if the tone that's gone
        for (let key of pianoKeys) {
            if ( key.note  === KEYCODES.indexOf(ev.keyCode) - pianoKeys[0].note) { //pianokeys[0] = offset when shifting
                try {
                    key.osc.disconnect(key.audioCtx.destination)
                }
                catch(e) {

                }
            }
        }
        if (ev.keyCode || ev.key || ev.code === 32) {
            spacePressed = false;
        }
        if (ev.keyCode || ev.key || ev.code === 18) {
            resetPressed = false;
        }
    }

    function keyDown(event) {
        let key = event.keyCode;
        for (let i = 0; i < KEYCODES.length; i++) {
            //map keycodes to 0 - 12 sheme
            if (key === KEYCODES[i] && !notesPressed.includes(i)) {
                notesPressed.push(i);
            }
        }
        RemoveAllDuplicates(notesPressed);
        notesPressed.sort((a, b) => a - b); //sort in ascending order\
        for (let key of notesPressed) {
            pianoKeys[key].osc.connect(pianoKeys[key].audioCtx.destination);
        }

        // -----  SPECIAL EFFECTS
        if (event.keyCode === 16) { //if SHIFT is pressed --> + 1 Octave
            pianoKeys.forEach(el => el.multiplyFreq(2))
        }
        if (event.keyCode === 32) {
            spacePressed = true;
        }
        if (event.keyCode === 18) {
            resetPressed = true;
        }
        if (event.keyCode === 91 || event.keyCode === 224) { //if COMMAND is pressed --> lower by 1 Octave
            pianoKeys.forEach(el => el.multiplyFreq(0.5));
        }
        // -----
    }

    class KeyBox {
        constructor(noteNumber) {
            this.heightDelta = 0;
            this.note = noteNumber;
            this.color = NumberToHSLa(noteNumber, undefined, "62.5%", 1);
            this.baseHeight = 15;
            this.myHeight = this.baseHeight;
            this.borderRad = 12;
            this.animSpeed = 2;
            this.heightLimit = 40 + this.myHeight + this.note * 2;
            this.divElem = document.createElement("div");
            this.divElem.setAttribute("class", "pianoKey" + " " + "key" + noteNumber); //group select in CSS
            // this.divElem.style.height = this.myHeight + "px";
            this.divElem.style.background = this.color;
        }
        insertText(text = "NO") {
            this.textElem = document.createElement("span");
            this.textElem.setAttribute("class", "noteText");
            this.textElem.textContent = text;
            this.divElem.appendChild(this.textElem);
        }
        setOsc(audioContext, freq = 1200, type = "triangle") {
            this.audioCtx = audioContext;
            this.osc = audioContext.createOscillator();
            this.osc.frequency.value = freq;
            this.osc.type = type;
            this.osc.connect(audioContext.destination);
            this.osc.start();
            this.osc.disconnect(audioContext.destination);
        }
        changeHeight(direction = nope) { //timeDelta as parameter
            //TODO ...there is a easier way to animate this...

            this.percentage = this.heightDelta / (this.heightLimit - this.baseHeight);
            //from 0 to 1
            let animationFx = Math.sin(this.percentage * Math.PI / 2);

            if (this.myHeight < this.heightLimit && direction === "up") {
                this.myHeight += this.animSpeed + animationFx;
            } else if (this.myHeight > this.baseHeight && direction === "down") {
                this.myHeight -= this.animSpeed + animationFx;
                if (this.myHeight < this.baseHeight) {
                    this.myHeight = this.baseHeight;
                }
            }
            this.heightDelta = this.myHeight - this.baseHeight; //update heightDelta
            this.borderRad = 5 + this.myHeight - this.baseHeight;
        }
        multiplyFreq(factor) {
            this.osc.frequency.value *= factor;
        }
    }
</script>
